## Тестовое задание

## User story

Общая постановка: Добавление заявки на ответственное хранение в базу данных.  
Ожидаемый результат: Заявка добавлена в базу, ошибки корректно обработаны. На бэке один метод по REST.  
Макет фронта:  
![image](image.png)



**Уточнения и предположения**

* Хранение файлов осуществляется общим сервисом common_files с базовым набором методов:
  * Сохранить файл
  * Удалить файл
  * Получить файл
  * получить имена файлов по идентификаторам
  * и.т.д.
* Авторизация пользователя происходит с получением токена, который содержит базовые атрибуты пользователя:
  * user_uuid - идентификатор пользователя контрагента
  * user_role - пользовательская роль
  * contractor_uuid - идентификатор контрагента
  * contractor_role - роль контрагента

* "Расширенная заявка" содержит дополнительные поля, которые не реализуются в рамках данной постановки
* Основная единица хранения объема - литры.
* Форма "Ответсвенное хранение" и "Аренда" отличаются по набору полей и заявки сохраняются разными методами.

## Поставленные задачи для разработчиков:

1. `[back]` Добавить таблицу orders в схеме storage. Описание таблицы: [orders.sql]
2. `[back]` Создать метод "Создание заявки" в сервисе order-crud в соответсвии с описанием:
   * Описание метода [Создание заявки]
   * Схема: [OpenApi]
3. `[front]` Отрисовать форму "Создание заявки" и подключить к методам бэка:
   * [Макет формы](image.png)
   * [Описание логики работы формы](#Описание-фронта)



## Описание фронта

**Мапинг полей и описание**

Форма предназначена для заполнения и отправки пользователем заявки на хранение груза на предварительно выбранном складе.

| Наименование поля на форме      | Поле в теле запроса | Описание                                                                                                           | Обязательно к заполнению | Значение по умолчанию |
|:--------------------------------|:--------------------|:-------------------------------------------------------------------------------------------------------------------|:------------------------:|:---------------------:|
| Наименование склада             | storage_uuid        | На форме отображается storage_title, полученный при открытии формы заявки. В теле запроса сохраняется storage_uuid |        Заполнено         |     storage_uuid      |
| Описание груза                  | cargo_description   | Многострочное текстовое поле с ограничением 800 символов                                                           |            Да            |                       |
| Общий объем - значение          | cargo_value         | Выводится в выбранных единицах измерения, передается в целых литрах. См. [Поле "Общий объём"](#Поле-Общий-объём)   |         Да, >=1          |                       |
| Общий объем - единица измерения | cargo_value_unit    | Предустановленный список значений. См. [Поле "Общий объём"](#Поле-Общий-объём)                                     |            Да            |    "м<sup>3</sup>"    |
| Общий вес                       | cargo_weight        | Общий вес. Указывается в тоннах, не более 3 знаков после запятой. Сохраняется и передается в целых киллограмах.    |         Да, >=1          |                       |
| Прикремпленные документы        | file_uuids          | Описание в разделе [Работа с файлами](#Работа-с-файлами)                                                           |           Нет            |                       |
| Срок хранения "с"               | from_storage_date   | Срок хранения "с". Сохраняется в формате даты.                                                                     |            Да            |     текущая дата      |
| Срок хранения "по"              | to_storage_date     | Срок хранения "по". Сохраняется в формате даты. Неактивно, если  is_timeless=TRUE                                  |           Нет            |                       |
| Признак "До востребования"      | is_timeless         | Признак "до востребования".                                                                                        |           Нет            |         False         |
| Сопроводительное письмо         | comment             | Многострочное текстовое поле с ограничением 1500 символов.                                                         |           Нет            |                       |
| Расширенная заявка              | is_extended         | Признак расширенной заявки. Переключатель задизейблен, значение  is_extended=false                                 |        Заполнено         |         False         |


### Работа с файлами

Работа с файлами происходит с использованием общего внутреннего сервиса common_files.  
При загрузке файла проверить его формат. Поддерживаются форматы:
* xls
* csv
* docx
* pdf

Если формат файла не соответсвует вышеперечисленным - вывести ошибку "Неправильный формат файла".

**Прикрепление файлов**
При загрузке файла пользователем выполняется метод "Сохранить файл".
   * Если получен ответ 200, то uuid файла сохраняется в массив file_uuids, а имя загруженного файла отображается в списке загруженных документов.
   * Если получена ошибка - uuid файла в массиве не сохраняется, текст ошибки выводится на экран.

**Открепление файлов**
Если в списке загруженных файлов пользователь нажал кнопку "Открепить", то:
  * Выполняется метод "Удалить файл" в сервисе common_files.
  * Независимо от ответа сервиса, uuid файла удаляется из массива file_uuids.

### Поле "Общий объём"

Поле отображается в указанных единицах. При сохранении передается в целых литрах. Перевод литров в отображаемую единицу происходит на фронте в соответсвии с указанным коэфициентом.

Дропдаун единц объема:

| Значение cargo_value_unit | Отображаемая единица | Описание         | Знаков после запятой | Коэфициент отображения |
|:--------------------------|:---------------------|:-----------------|:---------------------|:-----------------------|
| LITER                     | "Л"                  | Литры            | 3                    | 1000                   |
| METER3                    | "м<sup>3</sup>"      | Метры кубические | 0                    | 1                      |
| DAL                       | "Дал"                | Декалитры        | 1                    | 10                     |

Пример: "Пользователь указал 3,56 м<sup>3</sup>". В при сохранении значение полей должно быть:
``` json5
"cargo_value" : 3560,
"cargo_value_unit" : "Meter3"

```

### Кнопка "Отправить заявку"

**Проверка данных**  
Кнопка становится активной только если пройдены проверки:
1. Заполнены обязательные поля? указанные в таблице.
2. В "Срок хранения" заполнено поле "до" или стоит признак "до востребования"

**Действие кнопки**

При нажатии кнопки выполняется метод  `POST {server}/v1/order`
Поля заполняются в соответсвии с указанным выше мапингом.  
Пример тела запроса в опсиании метода: [Создание заявки]  
Если метод вернул ответ 201 - Вывести сообщение "Поздравляем, ваша заявка отправлена" и закрыть форму.  
Если метод вернул ошибку - вывести сообщение об ошибке на экран и оставить заполненную форму открытой.

## Постановка для бэка


### Методы REST api

#### Создание заявки

**Описание сервиса**

Эндпоинт `POST {server}/v1/order/{uuid}`

Параметры запроса:

{uuid} -идентификатор создаваемой заявки

Метод выполняется с токеном пользователя

[OpenApi]

**Пример тела запроса:**

```json5
{
  "cargo_description": "Комплекты деталей металопроката",
  "cargo_value": 0,
  "cargo_value_unit": "LITER",
  "cargo_weight": 0,
  "fileUuids": [
    "3fa85f64-5717-4562-b3fc-2c963f66afa6"
  ],
  "from_storage_date": "2020-12-29",
  "to_storage_date": "2020-12-29",
  "is_timeless": true,
  "comment": "Добрый день! Очень заинтересовал ваш склад"
}
```

**Логика работы метода:**
1. Получить идентификатор заявки в строке запроса и данные в теле запроса.
2. Сохранить данные в таблице [orders.sql] в соответствии с мапингом:

| Поле в таблице    | Поле в JSON если не указано иное       |
|:------------------|:---------------------------------------|
| uuid              | =uuid_generate_v1()                    |
| contractor_uuid   | contractor_uuid из токена пользователя |
| user_uuid         | user_uuid из токена пользователя       |
| storage_uuid      | storage_uuid                           |
| cargo_description | cargo_description                      |
| cargo_value       | cargo_value                            |
| cargo_value_unit  | cargo_value_unit                       |
| cargo_weight      | cargo_weight                           |
| file_uuids        | file_uuids                             |
| from_storage_date | from_storage_date                      |
| to_storage_date   | to_storage_date                        |
| is_timeless       | is_timeless                            |
| comment           | comment                                |
| is_extended       | is_extended                            |
| created_at        | =now()                                 |
| updated_at        | =now()                                 |
| archived_at       | null                                   |
| deleted_at        | null                                   |

3. В случае ошибки сохранения - вернуть ошибку в ответе метода.

[orders.sql]: /TestExam/orders.sql
[Создание заявки]: #Создание-заявки
[OpenApi]: /TestExam/OpenAPI.yaml